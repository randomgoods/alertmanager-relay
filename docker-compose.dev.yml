---

networks:
  alertmanager-relay:

services:
  alertmanager-relay:
    build: .
    environment:
      POLL_INTERVAL: "5s"
      SRC_ALERTMANAGER_URL: http://alertmanager-src:9093
      DST_ALERTMANAGER_URL: http://alertmanager-dst:9093
      ALERTMANAGER_API_VERSION: v1 # or v2
      DEBUG: "1"
    ports:
      - "9080:8080"
    healthcheck:
      test: ["CMD", "/healthcheck", "http://localhost:8080/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      alertmanager-src:
        condition: service_healthy
      alertmanager-dst:
        condition: service_healthy
    networks:
      alertmanager-relay:
  alertmanager-src:
    image: prom/alertmanager:v0.22.2
    restart: unless-stopped
    ports:
      - "9093:9093"
    volumes:
      - ./config/alertmanager:/etc/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
      - '--log.level=info'
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9093/-/healthy"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      alertmanager-relay:
  alertmanager-dst:
    image: prom/alertmanager:v0.22.2
    restart: unless-stopped
    ports:
      - "9095:9093"
    volumes:
      - ./config/alertmanager:/etc/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
      - '--log.level=info'
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9093/-/healthy"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      alertmanager-relay:

...
